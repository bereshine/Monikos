<head>
    <meta charset="utf-8">
    <!-- Load PayPal's checkout.js Library. -->
    <script src="https://www.paypalobjects.com/api/checkout.js" data-version-4 log-level="warn"></script>
    <script src="https://js.braintreegateway.com/web/dropin/1.4.0/js/dropin.min.js"></script>
    <!-- Load the client component. -->
    <script src="https://js.braintreegateway.com/web/3.19.1/js/client.min.js"></script>
    <!-- Load the PayPal Checkout component. -->
    <script src="https://js.braintreegateway.com/web/3.19.1/js/paypal-checkout.min.js"></script>
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<!--
        Template for making a transaction. Check developer's console for success/failure results
-->

<body>
    <div id="dropin-container"></div>
    <button id="submit-button">Request payment method</button>
    <div id="paypal-button"></div>
    <script>
        var button = document.querySelector('#submit-button');

        $.get("/payment-server.php", function(data, status) {
            createDropIn(data);
        });

        function createDropIn(token) {
            //dropin-ui
            braintree.dropin.create({
                authorization: token,
                container: '#dropin-container'
            }, function(createErr, instance) {
                //drop-in
                button.addEventListener('click', function() {
                    instance.requestPaymentMethod(function(err, payload) {
                        $.post("/set-transaction.php", {
                                nonce: payload.nonce
                            },
                            function(data, status) {
                                console.log(data);
                            });
                    });
                });
            });
            
            //paypal
            braintree.client.create({
                authorization: token
            }, function(clientErr, clientInstance) {

                // Stop if there was a problem creating the client.
                // This could happen if there is a network error or if the authorization
                // is invalid.
                if (clientErr) {
                    console.error('Error creating client:', clientErr);
                    return;
                }

                // Create a PayPal Checkout component.
                braintree.paypalCheckout.create({
                    client: clientInstance
                }, function(paypalCheckoutErr, paypalCheckoutInstance) {

                    // Stop if there was a problem creating PayPal Checkout.
                    // This could happen if there was a network error or if it's incorrectly
                    // configured.
                    if (paypalCheckoutErr) {
                        console.error('Error creating PayPal Checkout:', paypalCheckoutErr);
                        return;
                    }

                    // Set up PayPal with the checkout.js library
                    paypal.Button.render({
                        env: 'production', // or 'sandbox'

                        payment: function() {
                            return paypalCheckoutInstance.createPayment({
                                // Your PayPal options here. For available options, see
                                // http://braintree.github.io/braintree-web/current/PayPalCheckout.html#createPayment
                            });
                        },

                        onAuthorize: function(data, actions) {
                            return paypalCheckoutInstance.tokenizePayment(data)
                                .then(function(payload) {
                                    // Submit `payload.nonce` to your server.
                                });
                        },

                        onCancel: function(data) {
                            console.log('checkout.js payment cancelled', JSON.stringify(data, 0, 2));
                        },

                        onError: function(err) {
                            console.error('checkout.js error', err);
                        }
                    }, '#paypal-button').then(function() {
                        // The PayPal button will be rendered in an html element with the id
                        // `paypal-button`. This function will be called when the PayPal button
                        // is set up and ready to be used.
                    });

                });

            });
        }

    </script>
</body>
